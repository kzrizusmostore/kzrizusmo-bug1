<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IBRA CHRES Assistant</title>
    <!-- Linking Google Fonts For Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@32,400,0,0" />
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap");

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        :root {
            /* Warna tema baru - hitam, putih, ungu, pink */
            --text-color: #ffffff;
            --subheading-color: #cccccc;
            --placeholder-color: #aaaaaa;
            --primary-color: #0f0f23;
            --secondary-color: #1a1a2e;
            --secondary-hover-color: #252541;
            --scrollbar-color: #555555;
            --accent-color: #8B5CF6;
            --accent-secondary: #EC4899;
        }

        body.light-theme {
            /* Tema terang dengan skema warna yang sama */
            --text-color: #000000;
            --subheading-color: #666666;
            --placeholder-color: #888888;
            --primary-color: #f8f8ff;
            --secondary-color: #f0f0f5;
            --secondary-hover-color: #e0e0eb;
            --scrollbar-color: #c0c0c0;
            --accent-color: #8B5CF6;
            --accent-secondary: #EC4899;
        }

        body {
            color: var(--text-color);
            background: var(--primary-color);
            transition: background 0.3s ease;
        }

        .container {
            overflow-y: auto;
            padding: 32px 0 60px;
            height: calc(100vh - 127px);
            scrollbar-color: var(--scrollbar-color) transparent;
        }

        .container :where(.app-header, .suggestions, .message, .prompt-wrapper) {
            position: relative;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px;
            max-width: 990px;
        }

        .container .app-header {
            margin-top: 3vh;
            text-align: center;
        }

        .app-header .heading {
            font-size: 3rem;
            background: linear-gradient(to right, var(--accent-color), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .app-header .sub-heading {
            font-size: 1.5rem;
            color: var(--subheading-color);
        }

        .container .suggestions {
            width: 100%;
            list-style: none;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 9.5vh;
        }

        body.chats-active .container :where(.app-header, .suggestions) {
            display: none;
        }

        .suggestions .suggestions-item {
            cursor: pointer;
            padding: 18px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            border-radius: 16px;
            justify-content: space-between;
            background: var(--secondary-color);
            transition: 0.3s ease;
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .suggestions .suggestions-item:hover {
            background: var(--secondary-hover-color);
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(139, 92, 246, 0.3);
        }

        .suggestions .suggestions-item .text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .suggestions .suggestions-item .icon {
            width: 45px;
            height: 45px;
            display: flex;
            font-size: 1.4rem;
            align-self: flex-end;
            align-items: center;
            border-radius: 50%;
            justify-content: center;
            color: var(--accent-color);
            background: var(--primary-color);
        }

        .suggestions .suggestions-item:nth-child(2) .icon {
            color: var(--accent-secondary);
        }

        .suggestions .suggestions-item:nth-child(3) .icon {
            color: var(--accent-color);
        }

        .suggestions .suggestions-item:nth-child(4) .icon {
            color: var(--accent-secondary);
        }

        .container .chats-container {
            display: flex;
            gap: 20px;
            flex-direction: column;
        }

        .chats-container .message {
            display: flex;
            gap: 11px;
            align-items: flex-start;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chats-container .bot-message {
            margin: 9px auto;
        }

        .chats-container .user-message {
            flex-direction: column;
            align-items: flex-end;
        }

        .chats-container .user-message .message-text {
            padding: 12px 16px;
            max-width: 85%;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
            border-radius: 18px 18px 4px 18px;
            word-break: break-word;
            color: white;
            box-shadow: 0 4px 6px rgba(139, 92, 246, 0.2);
        }

        .chats-container .user-message .img-attachment {
            margin-top: -7px;
            width: 50%;
            border-radius: 13px 3px 13px 13px;
            max-width: 100%;
        }

        .chats-container .user-message .file-attachment {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 10px;
            margin-top: -7px;
            border-radius: 13px 3px 13px 13px;
            background: var(--secondary-color);
            max-width: 85%;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .chats-container .user-message .file-attachment span {
            color: var(--accent-color);
        }

        .container .prompt-container {
            position: fixed;
            width: 100%;
            left: 0;
            bottom: 0;
            padding: 16px 0;
            background: var(--primary-color);
            border-top: 1px solid var(--secondary-color);
        }

        .prompt-container :where(.prompt-wrapper, .prompt-form, .prompt-actions) {
            display: flex;
            gap: 12px;
            height: 56px;
            align-items: center;
        }

        .prompt-container .prompt-form {
            height: 100%;
            width: 100%;
            border-radius: 28px;
            background: var(--secondary-color);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }

        .prompt-form:focus-within {
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
        }

        .prompt-form .prompt-input {
            width: 100%;
            height: 100%;
            background: none;
            outline: none;
            border: none;
            font-size: 1rem;
            color: var(--text-color);
            padding-left: 24px;
        }

        .prompt-form .prompt-input::placeholder {
            color: var(--placeholder-color);
        }

        .prompt-wrapper button {
            width: 56px;
            height: 100%;
            flex-shrink: 0;
            cursor: pointer;
            border-radius: 50%;
            font-size: 1.4rem;
            border: none;
            color: var(--text-color);
            background: var(--secondary-color);
            transition: 0.3s ease;
            border: 1px solid rgba(139, 92, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prompt-wrapper :is(button:hover, #cancel-file-btn, .file-icon) {
            background: var(--secondary-hover-color);
        }

        .prompt-form .prompt-actions {
            gap: 5px;
            margin-right: 7px;
        }

        .prompt-wrapper .prompt-form :where(.file-upload-wrapper, button, img) {
            position: relative;
            height: 45px;
            width: 45px;
        }

        .prompt-form .prompt-actions #send-prompt-btn {
            color: #fff;
            display: none;
            background: linear-gradient(135deg, var(--accent-color), var(--accent-secondary));
        }

        .prompt-form .prompt-input:valid~.prompt-actions #send-prompt-btn {
            display: flex;
        }

        .prompt-form #send-prompt-btn:hover {
            transform: scale(1.05);
        }

        .prompt-form .file-upload-wrapper :where(button, img) {
            display: none;
            border-radius: 50%;
            object-fit: cover;
            position: absolute;
        }

        .prompt-form .file-upload-wrapper.active #add-file-btn {
            display: none;
        }

        .prompt-form .file-upload-wrapper #add-file-btn,
        .prompt-form .file-upload-wrapper.active.img-attached img,
        .prompt-form .file-upload-wrapper.active.file-attached .file-icon,
        .prompt-form .file-upload-wrapper.active:hover #cancel-file-btn {
            display: flex;
        }

        .prompt-form :is(#stop-response-btn:hover, #cancel-file-btn) {
            color: var(--accent-secondary);
        }

        .prompt-wrapper .prompt-form .file-icon {
            color: var(--accent-color);
        }

        .prompt-form #stop-response-btn,
        body.bot-responding .prompt-form .file-upload-wrapper {
            display: none;
        }

        body.bot-responding .prompt-form #stop-response-btn {
            display: flex;
        }

        /* FORMATTING TEKS YANG LEBIH BAIK */
        .message-content {
            line-height: 1.7;
            font-size: 15px;
            color: var(--text-color);
            padding: 15px;
            background: var(--secondary-color);
            border-radius: 18px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .message-content p {
            margin-bottom: 16px;
            word-spacing: 0.5px;
            letter-spacing: 0.2px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content strong {
            font-weight: 700;
            color: inherit;
        }

        .message-content em {
            font-style: italic;
            color: inherit;
        }

        .message-content h1, .message-content h2, .message-content h3, 
        .message-content h4, .message-content h5, .message-content h6 {
            margin: 20px 0 12px 0;
            font-weight: 600;
            line-height: 1.3;
            color: inherit;
        }

        .message-content h1 {
            font-size: 1.5em;
            border-bottom: 1px solid var(--subheading-color);
            padding-bottom: 8px;
        }

        .message-content h2 {
            font-size: 1.35em;
        }

        .message-content h3 {
            font-size: 1.2em;
        }

        .message-content h4 {
            font-size: 1.1em;
        }

        .message-content h5 {
            font-size: 1.05em;
        }

        .message-content h6 {
            font-size: 1em;
            color: var(--subheading-color);
        }

        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin-bottom: 6px;
            padding-left: 4px;
        }

        .message-content blockquote {
            border-left: 4px solid var(--accent-color);
            margin: 16px 0;
            padding: 12px 16px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            background: var(--secondary-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .message-content th, .message-content td {
            padding: 10px 12px;
            border: 1px solid var(--secondary-hover-color);
            text-align: left;
        }

        .message-content th {
            background: var(--secondary-hover-color);
            font-weight: 600;
        }

        .message-content code {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
            font-size: 0.85em;
        }

        .message-content pre {
            background: var(--secondary-color);
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            overflow-x: auto;
            border: 1px solid var(--secondary-hover-color);
            position: relative;
            white-space: pre;
            tab-size: 4;
            line-height: 1.5;
        }

        .message-content pre code {
            background: none;
            padding: 0;
            font-size: 0.9em;
            line-height: inherit;
            display: block;
            white-space: pre;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Courier New', monospace;
            color: var(--text-color);
        }

        .message-content a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
            color: var(--accent-secondary);
        }

        /* Tombol Home/Dashboard */
        .home-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 1px solid rgba(139, 92, 246, 0.2);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-decoration: none;
        }

        .home-btn:hover {
            background: var(--secondary-hover-color);
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(139, 92, 246, 0.3);
        }

        .home-btn .material-symbols-rounded {
            font-size: 1.5rem;
        }

        /* Responsive media query code for small screens */
        @media (max-width: 768px) {
            .container {
                padding: 20px 0 100px;
            }

            .app-header :is(.heading, .sub-heading) {
                font-size: 2rem;
                line-height: 1.4;
            }

            .app-header .sub-heading {
                font-size: 1.2rem;
            }

            .container .suggestions {
                grid-template-columns: 1fr;
                margin-top: 5vh;
            }

            .container .chats-container {
                gap: 15px;
            }

            .chats-container .bot-message {
                margin: 4px auto;
            }

            .chats-container .user-message .message-text {
                max-width: 90%;
            }

            .chats-container .user-message .file-attachment {
                max-width: 90%;
            }

            .prompt-container :where(.prompt-wrapper, .prompt-form, .prompt-actions) {
                gap: 8px;
                height: 53px;
            }

            .prompt-container button {
                width: 53px;
            }

            .prompt-form :is(.file-upload-wrapper, button, img) {
                height: 42px;
                width: 42px;
            }

            .prompt-form .prompt-input {
                padding-left: 20px;
            }

            .prompt-form .file-upload-wrapper.active #cancel-file-btn {
                opacity: 0;
            }

            .prompt-wrapper.hide-controls :where(#theme-toggle-btn, #delete-chats-btn, #home-btn) {
                display: none;
            }
            
            .message-content {
                font-size: 14px;
            }
            
            .message-content ul, .message-content ol {
                margin-left: 15px;
                padding-left: 15px;
            }

            .home-btn {
                top: 15px;
                left: 15px;
                width: 45px;
                height: 45px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px 0 90px;
            }

            .app-header :is(.heading, .sub-heading) {
                font-size: 1.7rem;
            }

            .app-header .sub-heading {
                font-size: 1rem;
            }

            .suggestions {
                margin-top: 5vh;
            }

            .suggestions .suggestions-item {
                padding: 15px;
            }

            .chats-container .user-message .message-text {
                max-width: 95%;
            }

            .chats-container .user-message .file-attachment {
                max-width: 95%;
            }
            
            .message-content {
                font-size: 14px;
            }
            
            .message-content ul, .message-content ol {
                margin-left: 10px;
                padding-left: 10px;
            }

            .home-btn {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }

            .home-btn .material-symbols-rounded {
                font-size: 1.3rem;
            }
        }
        
.message-content {
    line-height: 1.6;
    font-size: 14px;
    color: var(--text-color);
    text-align: left;
}

.message-content p {
    margin-bottom: 12px;
    word-spacing: 0.5px;
    letter-spacing: 0.2px;
}

.message-content p:last-child {
    margin-bottom: 0;
}

.message-content strong {
    font-weight: 700;
    color: inherit;
}

.message-content em {
    font-style: italic;
    color: inherit;
}

.message-content h1, .message-content h2, .message-content h3, 
.message-content h4, .message-content h5, .message-content h6 {
    margin: 16px 0 10px 0;
    font-weight: 600;
    line-height: 1.3;
    color: inherit;
}

.message-content h1 {
    font-size: 1.4em;
    border-bottom: 1px solid #3F0A5E;
    padding-bottom: 6px;
}

.message-content h2 {
    font-size: 1.3em;
}

.message-content h3 {
    font-size: 1.2em;
}

.message-content h4 {
    font-size: 1.1em;
}

.message-content h5 {
    font-size: 1.05em;
}

.message-content h6 {
    font-size: 1em;
    color: #BE60EE;
}

.message-content ul, .message-content ol {
    margin: 10px 0;
    padding-left: 20px;
}

.message-content li {
    margin-bottom: 6px;
    padding-left: 4px;
}

.message-content blockquote {
    border-left: 3px solid #BE60EE;
    margin: 12px 0;
    padding: 10px 15px;
    background: rgba(190, 96, 238, 0.1);
    border-radius: 0 8px 8px 0;
    font-style: italic;
}

.message-content code {
    background: rgba(190, 96, 238, 0.1);
    color: #BE60EE;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
}

.message-content pre {
    background: #1A0526;
    padding: 12px;
    border-radius: 8px;
    margin: 12px 0;
    overflow-x: auto;
    border: 1px solid #3F0A5E;
    position: relative;
}

.message-content pre code {
    background: none;
    padding: 0;
    font-size: 0.9em;
    line-height: 1.4;
    display: block;
    white-space: pre;
    font-family: 'Courier New', monospace;
    color: #E0E0E0;
}

.message-content a {
    color: #BE60EE;
    text-decoration: none;
    border-bottom: 1px solid #BE60EE;
}

.message-content a:hover {
    text-decoration: underline;
    color: #9a4ed1;
}
    </style>
</head>
<body>
    <!-- Tombol Home/Dashboard -->
    <a id="home-btn" class="home-btn" href="/dashboard">
        <span class="material-symbols-rounded">home</span>
    </a>

    <div class="container">
        <!-- App Header -->
        <header class="app-header">
            <h1 class="heading">Halo, selamat datang!</h1>
            <h4 class="sub-heading">Ada yang bisa saya bantu?</h4>
        </header>

        <!-- Suggestions List -->
        <ul class="suggestions">
            <li class="suggestions-item">
                <p class="text">Apa cuaca hari ini?</p>
                <span class="icon material-symbols-rounded">cloud</span>
            </li>
            <li class="suggestions-item">
                <p class="text">Rekomendasi film terbaru</p>
                <span class="icon material-symbols-rounded">movie</span>
            </li>
            <li class="suggestions-item">
                <p class="text">Cara membuat kue bolu</p>
                <span class="icon material-symbols-rounded">cake</span>
            </li>
            <li class="suggestions-item">
                <p class="text">Tips belajar yang efektif</p>
                <span class="icon material-symbols-rounded">school</span>
            </li>
        </ul>

        <!-- Chats -->
        <div class="chats-container"></div>

        <!-- Prompt Input -->
        <div class="prompt-container">
            <div class="prompt-wrapper">
                <form action="#" class="prompt-form">
                    <input type="text" placeholder="Tanyakan sesuatu..." class="prompt-input" required />
                    <div class="prompt-actions">
                        <!-- File Upload Wrapper -->
                        <div class="file-upload-wrapper">
                            <img src="#" class="file-preview" />
                            <input id="file-input" type="file" accept="image/*, .pdf, .txt, .csv" hidden />
                            <button type="button" class="file-icon material-symbols-rounded">description</button>
                            <button id="cancel-file-btn" type="button" class="material-symbols-rounded">close</button>
                            <button id="add-file-btn" type="button" class="material-symbols-rounded">attach_file</button>
                        </div>

                        <!-- Send Prompt and Stop Response Buttons -->
                        <button id="stop-response-btn" type="button" class="material-symbols-rounded">stop_circle</button>
                        <button id="send-prompt-btn" class="material-symbols-rounded">arrow_upward</button>
                    </div>
                </form>

                <!-- Theme and Delete Chats Buttons -->
                <button id="theme-toggle-btn" class="material-symbols-rounded">light_mode</button>
                <button id="delete-chats-btn" class="material-symbols-rounded">delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- Bagian Konfigurasi Utama ---
        const CONFIG = {
            APP_NAME: 'WormGpt',
            MODEL_NAME: 'gemini-2.5-flash-preview-09-2025',
            MAX_TOKENS: 4096,
            // API Keys yang kamu berikan digabungkan di sini
            API_KEYS: [
                "AIzaSyAiy9_KNVe6BTcyEqXpr5PTpZGG2M4OM-Q",
                "AIzaSyC9cVU2p0SwHarQ4tDbYcstPnoKswOPb5U",
                "AIzaSyBaX_MqkzbVPeB7LCAPo5n_oLYbBs75fO0",
                "AIzaSyCAUfB30nezOYK_r5DwoRIdajSXNCftwps"
            ],
            SYSTEM_PROMPT: "Anda adalah WormGpt, asisten AI teknis yang sangat mumpuni. Misi Anda adalah memberikan jawaban yang mendalam, jelas, dan komprehensif. Prioritaskan untuk memberikan penjelasan lengkap dan kode yang fungsional jika diminta. Selalu sertakan penjelasan mendetail dalam bahasa Indonesia sebelum dan sesudah blok kode untuk membantu pengguna memahami cara kerjanya. Berikan jawaban selengkap mungkin. Pengguna adalah seorang developer/modder yang fokus pada App Development, Reverse Engineering, dan pembuatan Bot."
        };
        // --- Akhir Bagian Konfigurasi Utama ---

        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const appHeader = document.getElementById('app-header');

        let messages = [];
        let currentApiKey = "";

        // Fungsi untuk memilih API Key secara acak
        function getRandomKey() {
            if (CONFIG.API_KEYS.length === 0) {
                console.error("Tidak ada API keys yang terdeteksi.");
                return;
            }
            const randomIndex = Math.floor(Math.random() * CONFIG.API_KEYS.length);
            currentApiKey = CONFIG.API_KEYS[randomIndex];
            console.log(`Menggunakan API Key #${randomIndex + 1}: ... (disembunyikan)`);
        }

        // Inisialisasi aplikasi
        function initializeApp() {
            // Set judul header dari CONFIG
            appHeader.textContent = CONFIG.APP_NAME;

            // Pilih API key awal
            getRandomKey();

            // Tampilkan pesan selamat datang
            displayInitialMessage();
        }

        function displayInitialMessage() {
            const initialMessage = `
                <span style="color: var(--red-accent); font-weight: bold;">${CONFIG.APP_NAME}:</span> 
                <span style="color: #00FF7F;">Sistem online.</span>
                <br>
                Selamat datang **${CONFIG.APP_NAME}** siap membantu **project App Development/Reverse Engineering** kamu hari ini. Yuk, langsung gas! ðŸš€
            `;
            displayMessage(initialMessage, 'ai');
        }

        // Handler untuk tombol Copy
        window.handleCopy = function(button) {
            const codeBlock = button.nextElementSibling; 
            const code = codeBlock.textContent.trim();

            const textarea = document.createElement('textarea');
            textarea.value = code;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            } catch (err) {
                console.error('Copy failed:', err);
            } finally {
                document.body.removeChild(textarea);
            }
        };

        // Fungsi untuk menampilkan pesan di jendela chat
        function displayMessage(content, sender, isError = false) {
            // 1. Format Code Block dengan Copy Button
            let formattedContent = content.replace(
                /```([\s\S]*?)```/g, 
                (match, code) => {
                    const cleanedCode = code.trim().replace(/^(python|javascript|html|css|json|bash|sh|)/i, '').trim();
                    const escapedCode = cleanedCode.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    return `<div class="code-container">
                                <button class="copy-button" onclick="handleCopy(this)">Copy</button>
                                <pre><code>${escapedCode}</code></pre>
                            </div>`;
                }
            );

            // 2. Format Inline Code, Bold, Italic, Strikethrough
            formattedContent = formattedContent.replace(/`([^`].*?)`/g, '<code>$1</code>');
            formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedContent = formattedContent.replace(/(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)/g, '<em>$1</em>');
            formattedContent = formattedContent.replace(/~~(.*?)~~/g, '<del>$1</del>');

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            if (isError) {
                messageDiv.classList.add('error-message');
            }
            
            messageDiv.innerHTML = formattedContent; 
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }

        // Fungsi utama pengiriman pesan ke Gemini API (SUDAH DIPERBAIKI)
        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            displayMessage(userMessage, 'user');
            
            messages.push({ role: "user", parts: [{ text: userMessage }] });

            chatInput.value = '';
            sendButton.disabled = true;
            sendButton.textContent = 'Processing';
            
            const aiLoadingDiv = displayMessage('AI sedang berpikir', 'ai');
            aiLoadingDiv.classList.add('loading');
            
            let attempts = 0;
            const maxAttempts = CONFIG.API_KEYS.length * 2;
            let success = false;

            while (attempts < maxAttempts && !success) {
                try {
                    if (!currentApiKey) {
                        getRandomKey();
                    }
                    if (!currentApiKey) {
                        throw new Error("API Key tidak tersedia.");
                    }
                    
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.MODEL_NAME}:generateContent?key=${currentApiKey}`;

                    // --- STRUKTUR PAYLOAD YANG BENAR UNTUK GEMINI API ---
                    const payload = {
                        contents: messages,
                        // systemInstruction di luar generationConfig
                        systemInstruction: { parts: [{ text: CONFIG.SYSTEM_PROMPT }] },
                        generationConfig: { // Menggunakan generationConfig
                            maxOutputTokens: CONFIG.MAX_TOKENS,
                        }
                    };
                    // -----------------------------------------------------

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Gemini API Response Error:', errorData);
                        getRandomKey(); // Coba ganti key
                        throw new Error(`API Error: ${response.status} ${response.statusText}. Detail: ${errorData.error?.message || 'Tidak ada detail pesan.'}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const aiContent = candidate?.content?.parts?.[0]?.text;
                    const finishReason = candidate?.finishReason; 

                    if (!aiContent) {
                        if (finishReason === 'SAFETY') {
                            console.error('Gemini Blocked Reason:', candidate.safetyRatings);
                            throw new Error("Respon diblokir. Konten melanggar kebijakan keamanan atau terlalu sensitif.");
                        }
                        if (finishReason === 'MAX_TOKENS') {
                             throw new Error("Respon terpotong. Jawaban AI terlalu panjang untuk batas MAX_TOKENS saat ini. Coba lagi.");
                        }
                        throw new Error("Respon AI kosong atau tidak valid.");
                    }

                    chatWindow.removeChild(aiLoadingDiv);
                    displayMessage(aiContent, 'ai');
                    messages.push({ role: "model", parts: [{ text: aiContent }] });
                    success = true; 
                    
                } catch (error) {
                    attempts++;
                    console.error(`Percobaan ke-${attempts} Gagal:`, error);
                    
                    getRandomKey();
                    
                    if (attempts >= maxAttempts) {
                        chatWindow.removeChild(aiLoadingDiv);
                        const errorMessage = `Gagal Koneksi API (Setelah ${maxAttempts} percobaan):<br><b>${error.message}</b><br><br><b>SOLUSI:</b><br>1. Sederhanakan prompt kamu.<br>2. Periksa kembali API Key (kemungkinan sudah expired/limit).`;
                        displayMessage(errorMessage, 'ai', true);
                        messages.pop(); 
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempts) * 100));
                }
            }

            sendButton.disabled = false;
            sendButton.textContent = 'Kirim';
            chatInput.focus();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initializeApp);

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
    </script>
</body>
</html>